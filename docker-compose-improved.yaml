services:
  sysbank-multi:
    build: .
    image: sysbank:qt4-multi-improved
    container_name: sysbank_multi
    ports:
      - "8080:8080"           # Gestor de instancias
      - "5900-5950:5900-5950" # Rango de puertos VNC (50 instancias)
      - "6080-6130:6080-6130" # Rango de puertos noVNC (50 instancias)
    environment:
      # Resolución mejorada (Full HD)
      - RESOLUTION=1920x1080x24
      
      # Qt optimizado
      - QT_X11_NO_MITSHM=1
      - QT_GRAPHICSSYSTEM=native
      
      # Aceleración gráfica Mesa optimizada
      - LIBGL_ALWAYS_SOFTWARE=1
      - GALLIUM_DRIVER=llvmpipe
      - LP_NUM_THREADS=4
      - MESA_GL_VERSION_OVERRIDE=3.3
      - MESA_GLSL_VERSION_OVERRIDE=330
      
      # Renderizado mejorado
      - MESA_EXTENSION_OVERRIDE=GL_ARB_texture_non_power_of_two
      - LIBGL_DRI3_DISABLE=1
      
      # X11 optimizado
      - __GL_SYNC_TO_VBLANK=0
      - __GL_YIELD=NOTHING
      
    volumes:
      - sysbank_data:/app/data
      - sysbank_instances:/app/instances
      
    restart: unless-stopped
    
    # Recursos aumentados para mejor rendimiento gráfico
    shm_size: '4gb'
    mem_limit: 8g
    cpus: 4
    
    # Capacidades necesarias para aceleración
    cap_add:
      - SYS_ADMIN
    
    security_opt:
      - seccomp:unconfined

volumes:
  sysbank_data:
    driver: local
  sysbank_instances:
    driver: local